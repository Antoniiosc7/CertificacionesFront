import { FlexibleConnectedPositionStrategy, } from '@angular/cdk/overlay';
import { NavigationEnd } from '@angular/router';
import { isPresent } from '@ng-doc/core/helpers/is-present';
import { toElement } from '@ng-doc/ui-kit/helpers';
import { fromSubscribe, ngDocZoneDetach, ngDocZoneOptimize } from '@ng-doc/ui-kit/observables';
import { fromEvent, merge, NEVER } from 'rxjs';
import { debounceTime, filter, map, pairwise, switchMap, take, takeUntil } from 'rxjs/operators';
export class NgDocOverlayRef {
    constructor(overlayRef, overlayConfig, overlayContainer, ngZone, router, location) {
        this.overlayRef = overlayRef;
        this.overlayConfig = overlayConfig;
        this.overlayContainer = overlayContainer;
        this.ngZone = ngZone;
        this.router = router;
        this.location = location;
        this.overlayResult = null;
        this.opened = true;
        /* Closes overlay when it was outside click */
        this.afterOpen()
            .pipe(switchMap(() => this.ngZone.runOutsideAngular(() => this.overlayRef.outsidePointerEvents())), filter((event) => !!this.overlayConfig.closeIfOutsideClick && this.outsideClickChecker(event)), ngDocZoneOptimize(this.ngZone))
            .subscribe(() => this.close());
        /* Closes overlay when it was inner click */
        fromEvent(this.overlayRef.overlayElement, 'click')
            .pipe(filter(() => !!this.overlayConfig.closeIfInnerClick), takeUntil(this.overlayRef.detachments()), ngDocZoneOptimize(this.ngZone))
            .subscribe(() => this.close());
        /* Closes overlay if route was changed */
        if (this.router && this.overlayConfig.disposeOnRouteNavigation) {
            this.router.events
                .pipe(filter((event) => event instanceof NavigationEnd), ngDocZoneOptimize(this.ngZone), takeUntil(this.overlayRef.detachments()))
                .subscribe(() => this.close());
        }
        if (this.location && this.overlayConfig.disposeOnNavigation) {
            fromSubscribe(this.location)
                .pipe(takeUntil(this.overlayRef.detachments()))
                .subscribe(() => this.close());
        }
        if (!this.overlayConfig.disableClose) {
            merge(this.overlayRef.backdropClick(), this.overlayRef.keydownEvents().pipe(filter((e) => e.code === 'Escape')))
                .pipe(take(1), takeUntil(this.overlayRef.detachments()))
                .subscribe(() => this.close());
        }
        /* Update position if origin changes its position */
        const origin = toElement(this.overlayConfig.origin);
        if (origin instanceof HTMLElement) {
            this.ngZone.onStable
                .pipe(debounceTime(10), map(() => origin.getBoundingClientRect()), pairwise(), filter(([a, b]) => isPresent(a) &&
                isPresent(b) &&
                (a.x !== b.x || a.y !== b.y || a.width !== b.width || a.height !== b.height)), ngDocZoneDetach(this.ngZone), takeUntil(this.overlayRef.detachments()))
                .subscribe(() => this.overlayRef.updatePosition());
        }
    }
    /** Sets focus to overlay */
    focus() {
        this.overlayContainer.focus();
    }
    /** Overlay has focus */
    get isFocused() {
        return this.overlayContainer.isFocused;
    }
    /** Overlay is opened */
    get isOpened() {
        return this.opened;
    }
    /** Overlay has attached */
    get hasAttached() {
        return this.overlayRef.hasAttached();
    }
    /**
     * Closes overlay
     * @param closeResult
     */
    close(closeResult) {
        this.overlayResult = isPresent(closeResult) ? closeResult : null;
        this.afterClose().subscribe(() => void this.overlayRef.detach());
        this.overlayContainer.close();
        this.overlayRef.detachBackdrop();
        this.opened = false;
    }
    beforeOpen() {
        return this.overlayContainer.animationEvent.pipe(filter((event) => event === 'beforeOpen'), take(1), map(() => void 0));
    }
    afterOpen() {
        return this.overlayContainer.animationEvent.pipe(filter((event) => event === 'afterOpen'), take(1), map(() => void 0));
    }
    beforeClose() {
        return merge(this.overlayContainer.animationEvent.pipe(filter((event) => event === 'beforeClose')), this.overlayRef.detachments()).pipe(take(1), map(() => this.overlayResult));
    }
    afterClose() {
        return merge(this.overlayContainer.animationEvent.pipe(filter((event) => event === 'afterClose')), this.overlayRef.detachments()).pipe(take(1), map(() => this.overlayResult));
    }
    positionChanges() {
        return this.overlayConfig.positionStrategy instanceof FlexibleConnectedPositionStrategy
            ? this.overlayConfig.positionStrategy.positionChanges
            : NEVER;
    }
    outsideClickChecker(event) {
        const target = event.target;
        if (target instanceof Element) {
            const origin = toElement(this.overlayConfig.origin);
            if (origin instanceof HTMLElement) {
                return !origin.contains(target);
            }
        }
        return true;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3ZlcmxheS1yZWYuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9saWJzL3VpLWtpdC9jbGFzc2VzL292ZXJsYXktcmVmL292ZXJsYXktcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTixpQ0FBaUMsR0FFakMsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QixPQUFPLEVBQVMsYUFBYSxFQUFVLE1BQU0saUJBQWlCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVuRCxPQUFPLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRS9GLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUMzRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakcsTUFBTSxPQUFPLGVBQWU7SUFJM0IsWUFDVSxVQUFzQixFQUNkLGFBQWlDLEVBQ3pDLGdCQUF1QyxFQUMvQixNQUFjLEVBQ2QsTUFBZSxFQUNmLFFBQW1CO1FBTDNCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDZCxrQkFBYSxHQUFiLGFBQWEsQ0FBb0I7UUFDekMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUF1QjtRQUMvQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsV0FBTSxHQUFOLE1BQU0sQ0FBUztRQUNmLGFBQVEsR0FBUixRQUFRLENBQVc7UUFUN0Isa0JBQWEsR0FBYSxJQUFJLENBQUM7UUFDL0IsV0FBTSxHQUFZLElBQUksQ0FBQztRQVU5Qiw4Q0FBOEM7UUFDOUMsSUFBSSxDQUFDLFNBQVMs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IjpbImltcG9ydCB7XG5cdENvbm5lY3RlZE92ZXJsYXlQb3NpdGlvbkNoYW5nZSxcblx0RmxleGlibGVDb25uZWN0ZWRQb3NpdGlvblN0cmF0ZWd5LFxuXHRPdmVybGF5UmVmLFxufSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEV2ZW50LCBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgaXNQcmVzZW50IH0gZnJvbSAnQG5nLWRvYy9jb3JlL2hlbHBlcnMvaXMtcHJlc2VudCc7XG5pbXBvcnQgeyB0b0VsZW1lbnQgfSBmcm9tICdAbmctZG9jL3VpLWtpdC9oZWxwZXJzJztcbmltcG9ydCB7IE5nRG9jT3ZlcmxheUNvbmZpZywgTmdEb2NPdmVybGF5Q29udGFpbmVyIH0gZnJvbSAnQG5nLWRvYy91aS1raXQvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBmcm9tU3Vic2NyaWJlLCBuZ0RvY1pvbmVEZXRhY2gsIG5nRG9jWm9uZU9wdGltaXplIH0gZnJvbSAnQG5nLWRvYy91aS1raXQvb2JzZXJ2YWJsZXMnO1xuaW1wb3J0IHsgTmdEb2NPdmVybGF5QW5pbWF0aW9uRXZlbnQgfSBmcm9tICdAbmctZG9jL3VpLWtpdC90eXBlcyc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIG1lcmdlLCBORVZFUiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBmaWx0ZXIsIG1hcCwgcGFpcndpc2UsIHN3aXRjaE1hcCwgdGFrZSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgY2xhc3MgTmdEb2NPdmVybGF5UmVmPFQgPSB1bmtub3duPiB7XG5cdHByaXZhdGUgb3ZlcmxheVJlc3VsdDogVCB8IG51bGwgPSBudWxsO1xuXHRwcml2YXRlIG9wZW5lZDogYm9vbGVhbiA9IHRydWU7XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0cmVhZG9ubHkgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcblx0XHRwcml2YXRlIHJlYWRvbmx5IG92ZXJsYXlDb25maWc6IE5nRG9jT3ZlcmxheUNvbmZpZyxcblx0XHRyZWFkb25seSBvdmVybGF5Q29udGFpbmVyOiBOZ0RvY092ZXJsYXlDb250YWluZXIsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBuZ1pvbmU6IE5nWm9uZSxcblx0XHRwcml2YXRlIHJlYWRvbmx5IHJvdXRlcj86IFJvdXRlcixcblx0XHRwcml2YXRlIHJlYWRvbmx5IGxvY2F0aW9uPzogTG9jYXRpb24sXG5cdCkge1xuXHRcdC8qIENsb3NlcyBvdmVybGF5IHdoZW4gaXQgd2FzIG91dHNpZGUgY2xpY2sgKi9cblx0XHR0aGlzLmFmdGVyT3BlbigpXG5cdFx0XHQucGlwZShcblx0XHRcdFx0c3dpdGNoTWFwKCgpID0+XG5cdFx0XHRcdFx0dGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gdGhpcy5vdmVybGF5UmVmLm91dHNpZGVQb2ludGVyRXZlbnRzKCkpLFxuXHRcdFx0XHQpLFxuXHRcdFx0XHRmaWx0ZXIoXG5cdFx0XHRcdFx0KGV2ZW50OiBNb3VzZUV2ZW50KSA9PlxuXHRcdFx0XHRcdFx0ISF0aGlzLm92ZXJsYXlDb25maWcuY2xvc2VJZk91dHNpZGVDbGljayAmJiB0aGlzLm91dHNpZGVDbGlja0NoZWNrZXIoZXZlbnQpLFxuXHRcdFx0XHQpLFxuXHRcdFx0XHRuZ0RvY1pvbmVPcHRpbWl6ZSh0aGlzLm5nWm9uZSksXG5cdFx0XHQpXG5cdFx0XHQuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xvc2UoKSk7XG5cblx0XHQvKiBDbG9zZXMgb3ZlcmxheSB3aGVuIGl0IHdhcyBpbm5lciBjbGljayAqL1xuXHRcdGZyb21FdmVudCh0aGlzLm92ZXJsYXlSZWYub3ZlcmxheUVsZW1lbnQsICdjbGljaycpXG5cdFx0XHQucGlwZShcblx0XHRcdFx0ZmlsdGVyKCgpID0+ICEhdGhpcy5vdmVybGF5Q29uZmlnLmNsb3NlSWZJbm5lckNsaWNrKSxcblx0XHRcdFx0dGFrZVVudGlsKHRoaXMub3ZlcmxheVJlZi5kZXRhY2htZW50cygpKSxcblx0XHRcdFx0bmdEb2Nab25lT3B0aW1pemUodGhpcy5uZ1pvbmUpLFxuXHRcdFx0KVxuXHRcdFx0LnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlKCkpO1xuXG5cdFx0LyogQ2xvc2VzIG92ZXJsYXkgaWYgcm91dGUgd2FzIGNoYW5nZWQgKi9cblx0XHRpZiAodGhpcy5yb3V0ZXIgJiYgdGhpcy5vdmVybGF5Q29uZmlnLmRpc3Bvc2VPblJvdXRlTmF2aWdhdGlvbikge1xuXHRcdFx0dGhpcy5yb3V0ZXIuZXZlbnRzXG5cdFx0XHRcdC5waXBlKFxuXHRcdFx0XHRcdGZpbHRlcigoZXZlbnQ6IEV2ZW50KSA9PiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpLFxuXHRcdFx0XHRcdG5nRG9jWm9uZU9wdGltaXplKHRoaXMubmdab25lKSxcblx0XHRcdFx0XHR0YWtlVW50aWwodGhpcy5vdmVybGF5UmVmLmRldGFjaG1lbnRzKCkpLFxuXHRcdFx0XHQpXG5cdFx0XHRcdC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5jbG9zZSgpKTtcblx0XHR9XG5cblx0XHRpZiAodGhpcy5sb2NhdGlvbiAmJiB0aGlzLm92ZXJsYXlDb25maWcuZGlzcG9zZU9uTmF2aWdhdGlvbikge1xuXHRcdFx0ZnJvbVN1YnNjcmliZSh0aGlzLmxvY2F0aW9uKVxuXHRcdFx0XHQucGlwZSh0YWtlVW50aWwodGhpcy5vdmVybGF5UmVmLmRldGFjaG1lbnRzKCkpKVxuXHRcdFx0XHQuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xvc2UoKSk7XG5cdFx0fVxuXG5cdFx0aWYgKCF0aGlzLm92ZXJsYXlDb25maWcuZGlzYWJsZUNsb3NlKSB7XG5cdFx0XHRtZXJnZShcblx0XHRcdFx0dGhpcy5vdmVybGF5UmVmLmJhY2tkcm9wQ2xpY2soKSxcblx0XHRcdFx0dGhpcy5vdmVybGF5UmVmLmtleWRvd25FdmVudHMoKS5waXBlKGZpbHRlcigoZTogS2V5Ym9hcmRFdmVudCkgPT4gZS5jb2RlID09PSAnRXNjYXBlJykpLFxuXHRcdFx0KVxuXHRcdFx0XHQucGlwZSh0YWtlKDEpLCB0YWtlVW50aWwodGhpcy5vdmVybGF5UmVmLmRldGFjaG1lbnRzKCkpKVxuXHRcdFx0XHQuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xvc2UoKSk7XG5cdFx0fVxuXG5cdFx0LyogVXBkYXRlIHBvc2l0aW9uIGlmIG9yaWdpbiBjaGFuZ2VzIGl0cyBwb3NpdGlvbiAqL1xuXHRcdGNvbnN0IG9yaWdpbjogdW5rbm93biA9IHRvRWxlbWVudCh0aGlzLm92ZXJsYXlDb25maWcub3JpZ2luKTtcblxuXHRcdGlmIChvcmlnaW4gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuXHRcdFx0dGhpcy5uZ1pvbmUub25TdGFibGVcblx0XHRcdFx0LnBpcGUoXG5cdFx0XHRcdFx0ZGVib3VuY2VUaW1lKDEwKSxcblx0XHRcdFx0XHRtYXAoKCkgPT4gb3JpZ2luLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKSxcblx0XHRcdFx0XHRwYWlyd2lzZSgpLFxuXHRcdFx0XHRcdGZpbHRlcihcblx0XHRcdFx0XHRcdChbYSwgYl06IFtET01SZWN0LCBET01SZWN0XSkgPT5cblx0XHRcdFx0XHRcdFx0aXNQcmVzZW50KGEpICYmXG5cdFx0XHRcdFx0XHRcdGlzUHJlc2VudChiKSAmJlxuXHRcdFx0XHRcdFx0XHQoYS54ICE9PSBiLnggfHwgYS55ICE9PSBiLnkgfHwgYS53aWR0aCAhPT0gYi53aWR0aCB8fCBhLmhlaWdodCAhPT0gYi5oZWlnaHQpLFxuXHRcdFx0XHRcdCksXG5cdFx0XHRcdFx0bmdEb2Nab25lRGV0YWNoKHRoaXMubmdab25lKSxcblx0XHRcdFx0XHR0YWtlVW50aWwodGhpcy5vdmVybGF5UmVmLmRldGFjaG1lbnRzKCkpLFxuXHRcdFx0XHQpXG5cdFx0XHRcdC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5vdmVybGF5UmVmLnVwZGF0ZVBvc2l0aW9uKCkpO1xuXHRcdH1cblx0fVxuXG5cdC8qKiBTZXRzIGZvY3VzIHRvIG92ZXJsYXkgKi9cblx0Zm9jdXMoKTogdm9pZCB7XG5cdFx0dGhpcy5vdmVybGF5Q29udGFpbmVyLmZvY3VzKCk7XG5cdH1cblxuXHQvKiogT3ZlcmxheSBoYXMgZm9jdXMgKi9cblx0Z2V0IGlzRm9jdXNlZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5vdmVybGF5Q29udGFpbmVyLmlzRm9jdXNlZDtcblx0fVxuXG5cdC8qKiBPdmVybGF5IGlzIG9wZW5lZCAqL1xuXHRnZXQgaXNPcGVuZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMub3BlbmVkO1xuXHR9XG5cblx0LyoqIE92ZXJsYXkgaGFzIGF0dGFjaGVkICovXG5cdGdldCBoYXNBdHRhY2hlZCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5vdmVybGF5UmVmLmhhc0F0dGFjaGVkKCk7XG5cdH1cblxuXHQvKipcblx0ICogQ2xvc2VzIG92ZXJsYXlcblx0ICogQHBhcmFtIGNsb3NlUmVzdWx0XG5cdCAqL1xuXHRjbG9zZShjbG9zZVJlc3VsdD86IFQpOiB2b2lkIHtcblx0XHR0aGlzLm92ZXJsYXlSZXN1bHQgPSBpc1ByZXNlbnQoY2xvc2VSZXN1bHQpID8gY2xvc2VSZXN1bHQgOiBudWxsO1xuXHRcdHRoaXMuYWZ0ZXJDbG9zZSgpLnN1YnNjcmliZSgoKSA9PiB2b2lkIHRoaXMub3ZlcmxheVJlZi5kZXRhY2goKSk7XG5cdFx0dGhpcy5vdmVybGF5Q29udGFpbmVyLmNsb3NlKCk7XG5cdFx0dGhpcy5vdmVybGF5UmVmLmRldGFjaEJhY2tkcm9wKCk7XG5cdFx0dGhpcy5vcGVuZWQgPSBmYWxzZTtcblx0fVxuXG5cdGJlZm9yZU9wZW4oKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG5cdFx0cmV0dXJuIHRoaXMub3ZlcmxheUNvbnRhaW5lci5hbmltYXRpb25FdmVudC5waXBlKFxuXHRcdFx0ZmlsdGVyKChldmVudDogTmdEb2NPdmVybGF5QW5pbWF0aW9uRXZlbnQpID0+IGV2ZW50ID09PSAnYmVmb3JlT3BlbicpLFxuXHRcdFx0dGFrZSgxKSxcblx0XHRcdG1hcCgoKSA9PiB2b2lkIDApLFxuXHRcdCk7XG5cdH1cblxuXHRhZnRlck9wZW4oKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG5cdFx0cmV0dXJuIHRoaXMub3ZlcmxheUNvbnRhaW5lci5hbmltYXRpb25FdmVudC5waXBlKFxuXHRcdFx0ZmlsdGVyKChldmVudDogTmdEb2NPdmVybGF5QW5pbWF0aW9uRXZlbnQpID0+IGV2ZW50ID09PSAnYWZ0ZXJPcGVuJyksXG5cdFx0XHR0YWtlKDEpLFxuXHRcdFx0bWFwKCgpID0+IHZvaWQgMCksXG5cdFx0KTtcblx0fVxuXG5cdGJlZm9yZUNsb3NlKCk6IE9ic2VydmFibGU8VCB8IG51bGw+IHtcblx0XHRyZXR1cm4gbWVyZ2UoXG5cdFx0XHR0aGlzLm92ZXJsYXlDb250YWluZXIuYW5pbWF0aW9uRXZlbnQucGlwZShcblx0XHRcdFx0ZmlsdGVyKChldmVudDogTmdEb2NPdmVybGF5QW5pbWF0aW9uRXZlbnQpID0+IGV2ZW50ID09PSAnYmVmb3JlQ2xvc2UnKSxcblx0XHRcdCksXG5cdFx0XHR0aGlzLm92ZXJsYXlSZWYuZGV0YWNobWVudHMoKSxcblx0XHQpLnBpcGUoXG5cdFx0XHR0YWtlKDEpLFxuXHRcdFx0bWFwKCgpID0+IHRoaXMub3ZlcmxheVJlc3VsdCksXG5cdFx0KTtcblx0fVxuXG5cdGFmdGVyQ2xvc2UoKTogT2JzZXJ2YWJsZTxUIHwgbnVsbD4ge1xuXHRcdHJldHVybiBtZXJnZShcblx0XHRcdHRoaXMub3ZlcmxheUNvbnRhaW5lci5hbmltYXRpb25FdmVudC5waXBlKFxuXHRcdFx0XHRmaWx0ZXIoKGV2ZW50OiBOZ0RvY092ZXJsYXlBbmltYXRpb25FdmVudCkgPT4gZXZlbnQgPT09ICdhZnRlckNsb3NlJyksXG5cdFx0XHQpLFxuXHRcdFx0dGhpcy5vdmVybGF5UmVmLmRldGFjaG1lbnRzKCksXG5cdFx0KS5waXBlKFxuXHRcdFx0dGFrZSgxKSxcblx0XHRcdG1hcCgoKSA9PiB0aGlzLm92ZXJsYXlSZXN1bHQpLFxuXHRcdCk7XG5cdH1cblxuXHRwb3NpdGlvbkNoYW5nZXMoKTogT2JzZXJ2YWJsZTxDb25uZWN0ZWRPdmVybGF5UG9zaXRpb25DaGFuZ2U+IHtcblx0XHRyZXR1cm4gdGhpcy5vdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3kgaW5zdGFuY2VvZiBGbGV4aWJsZUNvbm5lY3RlZFBvc2l0aW9uU3RyYXRlZ3lcblx0XHRcdD8gdGhpcy5vdmVybGF5Q29uZmlnLnBvc2l0aW9uU3RyYXRlZ3kucG9zaXRpb25DaGFuZ2VzXG5cdFx0XHQ6IE5FVkVSO1xuXHR9XG5cblx0cHJpdmF0ZSBvdXRzaWRlQ2xpY2tDaGVja2VyKGV2ZW50OiBNb3VzZUV2ZW50KTogYm9vbGVhbiB7XG5cdFx0Y29uc3QgdGFyZ2V0OiBFdmVudFRhcmdldCB8IG51bGwgPSBldmVudC50YXJnZXQ7XG5cdFx0aWYgKHRhcmdldCBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcblx0XHRcdGNvbnN0IG9yaWdpbjogdW5rbm93biA9IHRvRWxlbWVudCh0aGlzLm92ZXJsYXlDb25maWcub3JpZ2luKTtcblx0XHRcdGlmIChvcmlnaW4gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuXHRcdFx0XHRyZXR1cm4gIW9yaWdpbi5jb250YWlucyh0YXJnZXQpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxufVxuIl19