"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.build = build;
const operators_1 = require("rxjs/operators");
const operators_2 = require("../../operators");
const build_candidates_1 = require("../functions/build-candidates");
/**
 * Operator that updates the keyword map, builds the artifacts for each entity based on the
 * keyword relationships, and returns the built artifacts.
 * @param store - The entity store.
 * @param additionalEntities - Additional entities to build.
 */
function build(store, ...additionalEntities) {
    return (source) => source.pipe((0, operators_1.map)((entities) => (0, build_candidates_1.buildCandidates)(store, entities).filter((e) => e.isReadyForBuild)), (0, operators_1.switchMap)((entities) => (0, operators_2.forkJoinOrEmpty)(entities.map((e) => {
        e.beforeBuild();
        return e.build();
    }))), (0, operators_1.switchMap)((output) => (0, operators_2.forkJoinOrEmpty)((0, build_candidates_1.buildCandidates)(store, additionalEntities).map((e) => {
        e.beforeBuild();
        return e.build();
    })).pipe((0, operators_1.map)((additionalOutput) => output.concat(additionalOutput).flat()))));
}
//# sourceMappingURL=build.js.map