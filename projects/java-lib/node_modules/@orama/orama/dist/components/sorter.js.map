{"version":3,"sources":["../../src/components/sorter.ts"],"sourcesContent":["import { createError } from '../errors.js'\nimport { ISorter, OpaqueSorter, Orama, Schema, SorterConfig, SorterParams, SortType, SortValue } from '../types.js'\n\ninterface PropertySort<K> {\n  docs: Record<string, number>\n  orderedDocs: [string, K][]\n  type: SortType\n  n: number\n}\n\nexport interface Sorter extends OpaqueSorter {\n  enabled: boolean\n  sortableProperties: string[]\n  sortablePropertiesWithTypes: Record<string, SortType>\n  sorts: Record<string, PropertySort<number | string | boolean>>\n}\n\nexport type DefaultSorter = ISorter<Sorter>\n\nfunction innerCreate(schema: Schema, sortableDeniedProperties: string[], prefix: string): Sorter {\n  const sorter: Sorter = {\n    enabled: true,\n    sortableProperties: [],\n    sortablePropertiesWithTypes: {},\n    sorts: {},\n  }\n\n  for (const [prop, type] of Object.entries(schema)) {\n    const typeActualType = typeof type\n    const path = `${prefix}${prefix ? '.' : ''}${prop}`\n\n    if (sortableDeniedProperties.includes(path)) {\n      continue\n    }\n\n    if (typeActualType === 'object' && !Array.isArray(type)) {\n      // Nested\n      const ret = innerCreate(type as Schema, sortableDeniedProperties, path)\n      sorter.sortableProperties.push(...ret.sortableProperties)\n      sorter.sorts = {\n        ...sorter.sorts,\n        ...ret.sorts,\n      }\n      sorter.sortablePropertiesWithTypes = {\n        ...sorter.sortablePropertiesWithTypes,\n        ...ret.sortablePropertiesWithTypes,\n      }\n      continue\n    }\n\n    switch (type) {\n      case 'boolean':\n      case 'number':\n      case 'string':\n        sorter.sortableProperties.push(path)\n        sorter.sortablePropertiesWithTypes[path] = type\n        sorter.sorts[path] = {\n          docs: {},\n          orderedDocs: [],\n          type: type,\n          n: 0,\n        }\n        break\n      case 'boolean[]':\n      case 'number[]':\n      case 'string[]':\n        // We don't allow to sort by arrays\n        continue\n      default:\n        throw createError('INVALID_SORT_SCHEMA_TYPE', Array.isArray(type) ? 'array' : (type as unknown as string), path)\n    }\n  }\n\n  return sorter\n}\n\nasync function create(_: Orama, schema: Schema, config?: SorterConfig): Promise<Sorter> {\n  const isSortEnabled = config?.enabled !== false\n  if (!isSortEnabled) {\n    return {\n      disabled: true,\n    } as unknown as Sorter\n  }\n  return innerCreate(schema, (config || {}).unsortableProperties || [], '')\n}\n\nfunction stringSort(value: SortValue, language: string | undefined, d: [string, SortValue]): boolean {\n  return (d[1] as string).localeCompare(value as string, language) > 0\n}\nfunction numerSort(value: SortValue, d: [string, SortValue]): boolean {\n  return (d[1] as number) > (value as number)\n}\nfunction booleanSort(value: SortValue, d: [string, SortValue]): boolean {\n  return d[1] as boolean\n}\n\nasync function insert(\n  sorter: Sorter,\n  prop: string,\n  id: string,\n  value: SortValue,\n  schemaType: SortType,\n  language: string | undefined,\n): Promise<void> {\n  if (!sorter.enabled) {\n    return\n  }\n  const s = sorter.sorts[prop] as PropertySort<SortValue>\n\n  let predicate: (value: [string, SortValue]) => boolean\n  switch (schemaType) {\n    case 'string':\n      predicate = stringSort.bind(null, value, language)\n      break\n    case 'number':\n      predicate = numerSort.bind(null, value)\n      break\n    case 'boolean':\n      predicate = booleanSort.bind(null, value)\n      break\n  }\n\n  // Find the right position to insert the element\n  let index = s.orderedDocs.findIndex(predicate)\n  if (index === -1) {\n    index = s.orderedDocs.length\n    s.orderedDocs.push([id, value])\n  } else {\n    s.orderedDocs.splice(index, 0, [id, value])\n  }\n  s.docs[id] = index\n\n  // Increment position for the greather documents\n  const orderedDocsLength = s.orderedDocs.length\n  for (let i = index + 1; i < orderedDocsLength; i++) {\n    const docId = s.orderedDocs[i][0]\n    s.docs[docId]++\n  }\n}\n\nasync function remove(sorter: Sorter, prop: string, id: string) {\n  if (!sorter.enabled) {\n    return\n  }\n  const s = sorter.sorts[prop] as PropertySort<SortValue>\n\n  const index = s.docs[id]\n  delete s.docs[id]\n\n  // Decrement position for the greather documents\n  const orderedDocsLength = s.orderedDocs.length\n  for (let i = index + 1; i < orderedDocsLength; i++) {\n    const docId = s.orderedDocs[i][0]\n    s.docs[docId]--\n  }\n\n  s.orderedDocs.splice(index, 1)\n}\n\nasync function sortBy(sorter: Sorter, docIds: [string, number][], by: SorterParams): Promise<[string, number][]> {\n  if (!sorter.enabled) {\n    throw createError('SORT_DISABLED')\n  }\n\n  const property = by.property\n  const isDesc = by.order === 'DESC'\n\n  const s = sorter.sorts[property]\n  if (!s) {\n    throw createError('UNABLE_TO_SORT_ON_UNKNOWN_FIELD', property, sorter.sortableProperties.join(', '))\n  }\n\n  const docIdsLength = docIds.length\n\n  // Calculate how many documents aren't inside the sorter index.\n  // Used only for \"DESC\" sort.\n  let unsortableDocumentTotal = 0\n  if (isDesc) {\n    for (let i = 0; i < docIdsLength; i++) {\n      if (typeof s.docs[docIds[i][0]] === 'undefined') {\n        unsortableDocumentTotal++\n      }\n    }\n  }\n\n  let unsortableDocumentCount = 0\n  const ret = new Array(docIdsLength)\n  for (let i = 0; i < docIdsLength; i++) {\n    const d = docIds[i]\n    let pos = s.docs[d[0]]\n    if (typeof pos === 'undefined') {\n      unsortableDocumentCount++\n      pos = docIdsLength - unsortableDocumentCount\n    } else if (isDesc) {\n      pos = docIdsLength - unsortableDocumentTotal - pos - 1\n    }\n\n    ret[pos] = d\n  }\n\n  return ret\n}\n\nasync function getSortableProperties(sorter: Sorter): Promise<string[]> {\n  if (!sorter.enabled) {\n    return []\n  }\n\n  return sorter.sortableProperties\n}\n\nasync function getSortablePropertiesWithTypes(sorter: Sorter): Promise<Record<string, SortType>> {\n  if (!sorter.enabled) {\n    return {}\n  }\n\n  return sorter.sortablePropertiesWithTypes\n}\n\nexport async function load<R = unknown>(raw: R): Promise<Sorter> {\n  const rawDocument = raw as Sorter\n  if (!rawDocument.enabled) {\n    return {\n      enabled: false,\n    } as unknown as Sorter\n  }\n\n  return {\n    sortableProperties: rawDocument.sortableProperties,\n    sortablePropertiesWithTypes: rawDocument.sortablePropertiesWithTypes,\n    sorts: rawDocument.sorts,\n    enabled: true,\n  }\n}\n\nexport async function save<R = unknown>(sorter: Sorter): Promise<R> {\n  if (!sorter.enabled) {\n    return {\n      enabled: false,\n    } as unknown as R\n  }\n\n  return {\n    sortableProperties: sorter.sortableProperties,\n    sortablePropertiesWithTypes: sorter.sortablePropertiesWithTypes,\n    sorts: sorter.sorts,\n    enabled: sorter.enabled,\n  } as R\n}\n\nexport async function createSorter(): Promise<DefaultSorter> {\n  return {\n    create,\n    insert,\n    remove,\n    save,\n    load,\n    sortBy,\n    getSortableProperties,\n    getSortablePropertiesWithTypes,\n  }\n}\n"],"names":["createError","innerCreate","schema","sortableDeniedProperties","prefix","sorter","enabled","sortableProperties","sortablePropertiesWithTypes","sorts","prop","type","Object","entries","typeActualType","path","includes","Array","isArray","ret","push","docs","orderedDocs","n","create","_","config","isSortEnabled","disabled","unsortableProperties","stringSort","value","language","d","localeCompare","numerSort","booleanSort","insert","id","schemaType","s","predicate","bind","index","findIndex","length","splice","orderedDocsLength","i","docId","remove","sortBy","docIds","by","property","isDesc","order","join","docIdsLength","unsortableDocumentTotal","unsortableDocumentCount","pos","getSortableProperties","getSortablePropertiesWithTypes","load","raw","rawDocument","save","createSorter"],"mappings":"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"}