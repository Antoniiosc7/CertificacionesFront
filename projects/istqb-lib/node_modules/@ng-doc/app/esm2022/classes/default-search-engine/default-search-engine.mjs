import { NgDocSearchEngine } from '@ng-doc/app/classes/search-engine';
import { asArray } from '@ng-doc/core/helpers/as-array';
import { objectKeys } from '@ng-doc/core/helpers/object-keys';
import { create, insertMultiple } from '@orama/orama';
import { afterInsert, searchWithHighlight, } from '@orama/plugin-match-highlight';
import { from } from 'rxjs';
import { map, shareReplay, switchMap } from 'rxjs/operators';
/**
 * Search engine for the documentation, it loads the index and provides a search method.
 */
export class NgDocDefaultSearchEngine extends NgDocSearchEngine {
    constructor(options) {
        super();
        this.options = options;
        this.db$ = from(create({
            schema: {
                title: 'string',
                section: 'string',
                content: 'string',
            },
            components: {
                afterInsert: [afterInsert],
                tokenizer: {
                    stemmer: options?.stemmer,
                },
            },
        })).pipe(map((db) => db), switchMap((db) => this.request(`assets/ng-doc/indexes.json`).pipe(switchMap((pages) => insertMultiple(db, pages)), map(() => db))), shareReplay(1));
    }
    /**
     * Search the documentation for the given query.
     * @param query The query to search for.
     */
    search(query) {
        return this.db$.pipe(switchMap((db) => searchWithHighlight(db, {
            term: query,
            boost: { title: 4, section: 2 },
            properties: ['section', 'content'],
            tolerance: this.options?.tolerance,
            exact: this.options?.exact,
            limit: this.options?.limit ?? 10,
        })), map((result) => result.hits.map((hit) => {
            const keys = objectKeys(hit.positions);
            return {
                index: hit.document,
                positions: keys.reduce((acc, key) => {
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    // @ts-ignore
                    acc[key] = [...asArray(acc[key]), ...Object.values(hit.positions[key]).flat()];
                    return acc;
                }, {}),
            };
        })));
    }
    request(url) {
        return from(fetch(url)).pipe(switchMap((response) => response.json()));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zZWFyY2gtZW5naW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9hcHAvY2xhc3Nlcy9kZWZhdWx0LXNlYXJjaC1lbmdpbmUvZGVmYXVsdC1zZWFyY2gtZW5naW5lLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRXRFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQVMsTUFBTSxjQUFjLENBQUM7QUFFN0QsT0FBTyxFQUNOLFdBQVcsRUFHWCxtQkFBbUIsR0FDbkIsTUFBTSwrQkFBK0IsQ0FBQztBQUV2QyxPQUFPLEVBQUUsSUFBSSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBK0I3RDs7R0FFRztBQUNILE1BQU0sT0FBTyx3QkFBeUIsU0FBUSxpQkFBaUI7SUFHOUQsWUFBb0IsT0FBeUM7UUFDNUQsS0FBSyxFQUFFLENBQUM7UUFEVyxZQUFPLEdBQVAsT0FBTyxDQUFrQztRQUU1RCxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FDZCxNQUFNLENBQUM7WUFDTixNQUFNLEVBQUU7Z0JBQ1AsS0FBSyxFQUFFLFFBQVE7Z0JBQ2YsT0FBTyxFQUFFLFFBQVE7Z0JBQ2pCLE9BQU8sRUFBRSxRQUFRO2FBQ2pCO1lBQ0QsVUFBVSxFQUFFO2dCQUNYLFdBQVcsRUFBRSxDQUFDLFdBQVcsQ0FBQztnQkFDMUIsU0FBUyxFQUFFO29CQUNWLE9BQU8sRUFBRSxPQUFPLEVBQUUsT0FBTztpQkFDekI7YUFDRDtTQUNELENBQUMsQ0FDRixDQUFDLElBQUksQ0FDTCxHQUFHLENBQUMsQ0FBQyxFQUFTLEVBQUUsRUFBRSxDQUFDLEVBQXdCLENBQUMsRUFDNUMsU0FBUyxDQUFDLENBQUMsRUFBc0IsRUFBRSxFQUFFLENBQ3BDLElBQUksQ0FBQyxPQUFPLENBQW1CLDRCQUE0QixDQUFDLENBQUMsSUFBSSxDQUNoRSxTQUFTLENBQUMsQ0FBQyxLQUF1QixFQUFFLEVBQUUsQ0FDckMsY0FBYyxDQUFDLEVBQUUsRUFBRSxLQUFrQyxDQUFDLENBQ3RELEVBQ0QsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUNiLENBQ0QsRUFDRCxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQ29CLENBQUM7SUFDckMsQ0FBQztJQUVEOzs7T0FHRztJQUNILE1BQU0sQ0FBQyxLQUFhO1FBQ25CLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQ25CLFNBQVMsQ0FBQyxDQUFDLEVBQXNCLEVBQUUsRUFBRSxDQUNwQyxtQkFBbUIsQ0FBQyxFQUFFLEVBQUU7WUFDdkIsSUFBSSxFQUFFLEtBQUs7WUFDWCxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUU7WUFDL0IsVUFBVSxFQUFFLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQztZQUNsQyxTQUFTLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxTQUFTO1lBQ2xDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUs7WUFDMUIsS0FBSyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxJQUFJLEVBQUU7U0FDaEMsQ0FBQyxDQUNGLEVBQ0QsR0FBRyxDQUFDLENBQUMsTUFBaUMsRUFBRSxFQUFFLENBQ3pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBeUMsRUFBRSxFQUFFO1lBQzdELE1BQU0sSUFBSSxHQUFnQyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FFakUsQ0FBQztZQUVGLE9BQU87Z0JBQ04sS0FBSyxFQUFFLEdBQUcsQ0FBQyxRQUFxQztnQkFDaEQsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQ3JCLENBQ0MsR0FBMkQsRUFDM0QsR0FBeUIsRUFDeEIsRUFBRTtvQkFDSCw2REFBNkQ7b0JBQzdELGFBQWE7b0JBQ2IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO29CQUUvRSxPQUFPLEdBQUcsQ0FBQztnQkFDWixDQUFDLEVBQ0QsRUFBUyxDQUMwRDthQUNwRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQ0YsQ0FDRCxDQUFDO0lBQ0gsQ0FBQztJQUVPLE9BQU8sQ0FBSSxHQUFXO1FBQzdCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFrQixFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFnQixDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZ0RvY1NlYXJjaEVuZ2luZSB9IGZyb20gJ0BuZy1kb2MvYXBwL2NsYXNzZXMvc2VhcmNoLWVuZ2luZSc7XG5pbXBvcnQgeyBOZ0RvY1NlYXJjaFJlc3VsdCB9IGZyb20gJ0BuZy1kb2MvYXBwL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYXNBcnJheSB9IGZyb20gJ0BuZy1kb2MvY29yZS9oZWxwZXJzL2FzLWFycmF5JztcbmltcG9ydCB7IG9iamVjdEtleXMgfSBmcm9tICdAbmctZG9jL2NvcmUvaGVscGVycy9vYmplY3Qta2V5cyc7XG5pbXBvcnQgeyBOZ0RvY1BhZ2VJbmRleCB9IGZyb20gJ0BuZy1kb2MvY29yZS9pbnRlcmZhY2VzJztcbmltcG9ydCB7IE5nRG9jSGlnaGxpZ2h0UG9zaXRpb24gfSBmcm9tICdAbmctZG9jL3VpLWtpdCc7XG5pbXBvcnQgeyBjcmVhdGUsIGluc2VydE11bHRpcGxlLCBPcmFtYSB9IGZyb20gJ0BvcmFtYS9vcmFtYSc7XG5pbXBvcnQgeyBEb2N1bWVudCB9IGZyb20gJ0BvcmFtYS9vcmFtYS9kaXN0L3R5cGVzJztcbmltcG9ydCB7XG5cdGFmdGVySW5zZXJ0LFxuXHRPcmFtYVdpdGhIaWdobGlnaHQsXG5cdFNlYXJjaFJlc3VsdFdpdGhIaWdobGlnaHQsXG5cdHNlYXJjaFdpdGhIaWdobGlnaHQsXG59IGZyb20gJ0BvcmFtYS9wbHVnaW4tbWF0Y2gtaGlnaGxpZ2h0JztcbmltcG9ydCAqIGFzIHN0ZW1tZXIgZnJvbSAnQG9yYW1hL3N0ZW1tZXJzJztcbmltcG9ydCB7IGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXksIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgYE5nRG9jRGVmYXVsdFNlYXJjaEVuZ2luZWAuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgTmdEb2NEZWZhdWx0U2VhcmNoRW5naW5lT3B0aW9ucyB7XG5cdC8qKlxuXHQgKiBUaGUgbGFuZ3VhZ2UgdG8gdXNlIGZvciB0aGUgc2VhcmNoIGVuZ2luZS5cblx0ICovXG5cdHN0ZW1tZXI/OiB0eXBlb2Ygc3RlbW1lci5zdGVtbWVyO1xuXHQvKipcblx0ICogU3BlY2lmaWVzIHRoZSBtYXhpbXVtIGRpc3RhbmNlIChmb2xsb3dpbmcgdGhlIExldmVuc2h0ZWluIGFsZ29yaXRobSkgYmV0d2VlbiB0aGUgdGVybSBhbmQgdGhlIHNlYXJjaGFibGUgcHJvcGVydHkuXG5cdCAqIChkb2Vzbid0IHdvcmsgd2l0aCBgZXhhY3RgIG9wdGlvbilcblx0ICovXG5cdHRvbGVyYW5jZT86IG51bWJlcjtcblx0LyoqXG5cdCAqIElmIGB0cnVlYCwgZmluZHMgYWxsIHRoZSBkb2N1bWVudCB3aXRoIGFuIGV4YWN0IG1hdGNoIG9mIHRoZSB0ZXJtIHByb3BlcnR5LlxuXHQgKi9cblx0ZXhhY3Q/OiBib29sZWFuO1xuXHQvKipcblx0ICogTnVtYmVyIG9mIHJlc3VsdHMgdG8gcmV0dXJuIChkZWZhdWx0OiAxMCkuXG5cdCAqL1xuXHRsaW1pdD86IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFNlYXJjaFNjaGVtYSBleHRlbmRzIERvY3VtZW50IHtcblx0dGl0bGU6ICdzdHJpbmcnO1xuXHRzZWN0aW9uVGl0bGU6ICdzdHJpbmcnO1xuXHRjb250ZW50OiAnc3RyaW5nJztcbn1cblxuLyoqXG4gKiBTZWFyY2ggZW5naW5lIGZvciB0aGUgZG9jdW1lbnRhdGlvbiwgaXQgbG9hZHMgdGhlIGluZGV4IGFuZCBwcm92aWRlcyBhIHNlYXJjaCBtZXRob2QuXG4gKi9cbmV4cG9ydCBjbGFzcyBOZ0RvY0RlZmF1bHRTZWFyY2hFbmdpbmUgZXh0ZW5kcyBOZ0RvY1NlYXJjaEVuZ2luZSB7XG5cdHByaXZhdGUgZGIkOiBPYnNlcnZhYmxlPE9yYW1hV2l0aEhpZ2hsaWdodD47XG5cblx0Y29uc3RydWN0b3IocHJpdmF0ZSBvcHRpb25zPzogTmdEb2NEZWZhdWx0U2VhcmNoRW5naW5lT3B0aW9ucykge1xuXHRcdHN1cGVyKCk7XG5cdFx0dGhpcy5kYiQgPSBmcm9tKFxuXHRcdFx0Y3JlYXRlKHtcblx0XHRcdFx0c2NoZW1hOiB7XG5cdFx0XHRcdFx0dGl0bGU6ICdzdHJpbmcnLFxuXHRcdFx0XHRcdHNlY3Rpb246ICdzdHJpbmcnLFxuXHRcdFx0XHRcdGNvbnRlbnQ6ICdzdHJpbmcnLFxuXHRcdFx0XHR9LFxuXHRcdFx0XHRjb21wb25lbnRzOiB7XG5cdFx0XHRcdFx0YWZ0ZXJJbnNlcnQ6IFthZnRlckluc2VydF0sXG5cdFx0XHRcdFx0dG9rZW5pemVyOiB7XG5cdFx0XHRcdFx0XHRzdGVtbWVyOiBvcHRpb25zPy5zdGVtbWVyLFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdH0sXG5cdFx0XHR9KSxcblx0XHQpLnBpcGUoXG5cdFx0XHRtYXAoKGRiOiBPcmFtYSkgPT4gZGIgYXMgT3JhbWFXaXRoSGlnaGxpZ2h0KSxcblx0XHRcdHN3aXRjaE1hcCgoZGI6IE9yYW1hV2l0aEhpZ2hsaWdodCkgPT5cblx0XHRcdFx0dGhpcy5yZXF1ZXN0PE5nRG9jUGFnZUluZGV4W10+KGBhc3NldHMvbmctZG9jL2luZGV4ZXMuanNvbmApLnBpcGUoXG5cdFx0XHRcdFx0c3dpdGNoTWFwKChwYWdlczogTmdEb2NQYWdlSW5kZXhbXSkgPT5cblx0XHRcdFx0XHRcdGluc2VydE11bHRpcGxlKGRiLCBwYWdlcyBhcyB1bmtub3duIGFzIFNlYXJjaFNjaGVtYVtdKSxcblx0XHRcdFx0XHQpLFxuXHRcdFx0XHRcdG1hcCgoKSA9PiBkYiksXG5cdFx0XHRcdCksXG5cdFx0XHQpLFxuXHRcdFx0c2hhcmVSZXBsYXkoMSksXG5cdFx0KSBhcyBPYnNlcnZhYmxlPE9yYW1hV2l0aEhpZ2hsaWdodD47XG5cdH1cblxuXHQvKipcblx0ICogU2VhcmNoIHRoZSBkb2N1bWVudGF0aW9uIGZvciB0aGUgZ2l2ZW4gcXVlcnkuXG5cdCAqIEBwYXJhbSBxdWVyeSBUaGUgcXVlcnkgdG8gc2VhcmNoIGZvci5cblx0ICovXG5cdHNlYXJjaChxdWVyeTogc3RyaW5nKTogT2JzZXJ2YWJsZTxOZ0RvY1NlYXJjaFJlc3VsdFtdPiB7XG5cdFx0cmV0dXJuIHRoaXMuZGIkLnBpcGUoXG5cdFx0XHRzd2l0Y2hNYXAoKGRiOiBPcmFtYVdpdGhIaWdobGlnaHQpID0+XG5cdFx0XHRcdHNlYXJjaFdpdGhIaWdobGlnaHQoZGIsIHtcblx0XHRcdFx0XHR0ZXJtOiBxdWVyeSxcblx0XHRcdFx0XHRib29zdDogeyB0aXRsZTogNCwgc2VjdGlvbjogMiB9LFxuXHRcdFx0XHRcdHByb3BlcnRpZXM6IFsnc2VjdGlvbicsICdjb250ZW50J10sXG5cdFx0XHRcdFx0dG9sZXJhbmNlOiB0aGlzLm9wdGlvbnM/LnRvbGVyYW5jZSxcblx0XHRcdFx0XHRleGFjdDogdGhpcy5vcHRpb25zPy5leGFjdCxcblx0XHRcdFx0XHRsaW1pdDogdGhpcy5vcHRpb25zPy5saW1pdCA/PyAxMCxcblx0XHRcdFx0fSksXG5cdFx0XHQpLFxuXHRcdFx0bWFwKChyZXN1bHQ6IFNlYXJjaFJlc3VsdFdpdGhIaWdobGlnaHQpID0+XG5cdFx0XHRcdHJlc3VsdC5oaXRzLm1hcCgoaGl0OiBTZWFyY2hSZXN1bHRXaXRoSGlnaGxpZ2h0WydoaXRzJ11bMF0pID0+IHtcblx0XHRcdFx0XHRjb25zdCBrZXlzOiBBcnJheTxrZXlvZiBOZ0RvY1BhZ2VJbmRleD4gPSBvYmplY3RLZXlzKGhpdC5wb3NpdGlvbnMpIGFzIHVua25vd24gYXMgQXJyYXk8XG5cdFx0XHRcdFx0XHRrZXlvZiBOZ0RvY1BhZ2VJbmRleFxuXHRcdFx0XHRcdD47XG5cblx0XHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFx0aW5kZXg6IGhpdC5kb2N1bWVudCBhcyB1bmtub3duIGFzIE5nRG9jUGFnZUluZGV4LFxuXHRcdFx0XHRcdFx0cG9zaXRpb25zOiBrZXlzLnJlZHVjZShcblx0XHRcdFx0XHRcdFx0KFxuXHRcdFx0XHRcdFx0XHRcdGFjYzogUmVjb3JkPGtleW9mIE5nRG9jUGFnZUluZGV4LCBOZ0RvY0hpZ2hsaWdodFBvc2l0aW9uW10+LFxuXHRcdFx0XHRcdFx0XHRcdGtleToga2V5b2YgTmdEb2NQYWdlSW5kZXgsXG5cdFx0XHRcdFx0XHRcdCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvYmFuLXRzLWNvbW1lbnRcblx0XHRcdFx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0XHRcdFx0YWNjW2tleV0gPSBbLi4uYXNBcnJheShhY2Nba2V5XSksIC4uLk9iamVjdC52YWx1ZXMoaGl0LnBvc2l0aW9uc1trZXldKS5mbGF0KCldO1xuXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIGFjYztcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0e30gYXMgYW55LFxuXHRcdFx0XHRcdFx0KSBhcyBQYXJ0aWFsPFJlY29yZDxrZXlvZiBOZ0RvY1BhZ2VJbmRleCwgTmdEb2NIaWdobGlnaHRQb3NpdGlvbltdPj4sXG5cdFx0XHRcdFx0fTtcblx0XHRcdFx0fSksXG5cdFx0XHQpLFxuXHRcdCk7XG5cdH1cblxuXHRwcml2YXRlIHJlcXVlc3Q8VD4odXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFQ+IHtcblx0XHRyZXR1cm4gZnJvbShmZXRjaCh1cmwpKS5waXBlKHN3aXRjaE1hcCgocmVzcG9uc2U6IFJlc3BvbnNlKSA9PiByZXNwb25zZS5qc29uKCkgYXMgUHJvbWlzZTxUPikpO1xuXHR9XG59XG4iXX0=