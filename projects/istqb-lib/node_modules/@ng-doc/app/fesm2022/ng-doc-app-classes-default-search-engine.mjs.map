{"version":3,"file":"ng-doc-app-classes-default-search-engine.mjs","sources":["../../../../libs/app/classes/default-search-engine/default-search-engine.ts","../../../../libs/app/classes/default-search-engine/ng-doc-app-classes-default-search-engine.ts"],"sourcesContent":["import { NgDocSearchEngine } from '@ng-doc/app/classes/search-engine';\nimport { NgDocSearchResult } from '@ng-doc/app/interfaces';\nimport { asArray } from '@ng-doc/core/helpers/as-array';\nimport { objectKeys } from '@ng-doc/core/helpers/object-keys';\nimport { NgDocPageIndex } from '@ng-doc/core/interfaces';\nimport { NgDocHighlightPosition } from '@ng-doc/ui-kit';\nimport { create, insertMultiple, Orama } from '@orama/orama';\nimport { Document } from '@orama/orama/dist/types';\nimport {\n\tafterInsert,\n\tOramaWithHighlight,\n\tSearchResultWithHighlight,\n\tsearchWithHighlight,\n} from '@orama/plugin-match-highlight';\nimport * as stemmer from '@orama/stemmers';\nimport { from, Observable } from 'rxjs';\nimport { map, shareReplay, switchMap } from 'rxjs/operators';\n\n/**\n * Options for the `NgDocDefaultSearchEngine`.\n */\nexport interface NgDocDefaultSearchEngineOptions {\n\t/**\n\t * The language to use for the search engine.\n\t */\n\tstemmer?: typeof stemmer.stemmer;\n\t/**\n\t * Specifies the maximum distance (following the Levenshtein algorithm) between the term and the searchable property.\n\t * (doesn't work with `exact` option)\n\t */\n\ttolerance?: number;\n\t/**\n\t * If `true`, finds all the document with an exact match of the term property.\n\t */\n\texact?: boolean;\n\t/**\n\t * Number of results to return (default: 10).\n\t */\n\tlimit?: number;\n}\n\ninterface SearchSchema extends Document {\n\ttitle: 'string';\n\tsectionTitle: 'string';\n\tcontent: 'string';\n}\n\n/**\n * Search engine for the documentation, it loads the index and provides a search method.\n */\nexport class NgDocDefaultSearchEngine extends NgDocSearchEngine {\n\tprivate db$: Observable<OramaWithHighlight>;\n\n\tconstructor(private options?: NgDocDefaultSearchEngineOptions) {\n\t\tsuper();\n\t\tthis.db$ = from(\n\t\t\tcreate({\n\t\t\t\tschema: {\n\t\t\t\t\ttitle: 'string',\n\t\t\t\t\tsection: 'string',\n\t\t\t\t\tcontent: 'string',\n\t\t\t\t},\n\t\t\t\tcomponents: {\n\t\t\t\t\tafterInsert: [afterInsert],\n\t\t\t\t\ttokenizer: {\n\t\t\t\t\t\tstemmer: options?.stemmer,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t}),\n\t\t).pipe(\n\t\t\tmap((db: Orama) => db as OramaWithHighlight),\n\t\t\tswitchMap((db: OramaWithHighlight) =>\n\t\t\t\tthis.request<NgDocPageIndex[]>(`assets/ng-doc/indexes.json`).pipe(\n\t\t\t\t\tswitchMap((pages: NgDocPageIndex[]) =>\n\t\t\t\t\t\tinsertMultiple(db, pages as unknown as SearchSchema[]),\n\t\t\t\t\t),\n\t\t\t\t\tmap(() => db),\n\t\t\t\t),\n\t\t\t),\n\t\t\tshareReplay(1),\n\t\t) as Observable<OramaWithHighlight>;\n\t}\n\n\t/**\n\t * Search the documentation for the given query.\n\t * @param query The query to search for.\n\t */\n\tsearch(query: string): Observable<NgDocSearchResult[]> {\n\t\treturn this.db$.pipe(\n\t\t\tswitchMap((db: OramaWithHighlight) =>\n\t\t\t\tsearchWithHighlight(db, {\n\t\t\t\t\tterm: query,\n\t\t\t\t\tboost: { title: 4, section: 2 },\n\t\t\t\t\tproperties: ['section', 'content'],\n\t\t\t\t\ttolerance: this.options?.tolerance,\n\t\t\t\t\texact: this.options?.exact,\n\t\t\t\t\tlimit: this.options?.limit ?? 10,\n\t\t\t\t}),\n\t\t\t),\n\t\t\tmap((result: SearchResultWithHighlight) =>\n\t\t\t\tresult.hits.map((hit: SearchResultWithHighlight['hits'][0]) => {\n\t\t\t\t\tconst keys: Array<keyof NgDocPageIndex> = objectKeys(hit.positions) as unknown as Array<\n\t\t\t\t\t\tkeyof NgDocPageIndex\n\t\t\t\t\t>;\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tindex: hit.document as unknown as NgDocPageIndex,\n\t\t\t\t\t\tpositions: keys.reduce(\n\t\t\t\t\t\t\t(\n\t\t\t\t\t\t\t\tacc: Record<keyof NgDocPageIndex, NgDocHighlightPosition[]>,\n\t\t\t\t\t\t\t\tkey: keyof NgDocPageIndex,\n\t\t\t\t\t\t\t) => {\n\t\t\t\t\t\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\t\tacc[key] = [...asArray(acc[key]), ...Object.values(hit.positions[key]).flat()];\n\n\t\t\t\t\t\t\t\treturn acc;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{} as any,\n\t\t\t\t\t\t) as Partial<Record<keyof NgDocPageIndex, NgDocHighlightPosition[]>>,\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t),\n\t\t);\n\t}\n\n\tprivate request<T>(url: string): Observable<T> {\n\t\treturn from(fetch(url)).pipe(switchMap((response: Response) => response.json() as Promise<T>));\n\t}\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":";;;;;;;;AA+CA;;AAEG;AACG,MAAO,wBAAyB,SAAQ,iBAAiB,CAAA;AAG9D,IAAA,WAAA,CAAoB,OAAyC,EAAA;AAC5D,QAAA,KAAK,EAAE,CAAC;QADW,IAAO,CAAA,OAAA,GAAP,OAAO,CAAkC;AAE5D,QAAA,IAAI,CAAC,GAAG,GAAG,IAAI,CACd,MAAM,CAAC;AACN,YAAA,MAAM,EAAE;AACP,gBAAA,KAAK,EAAE,QAAQ;AACf,gBAAA,OAAO,EAAE,QAAQ;AACjB,gBAAA,OAAO,EAAE,QAAQ;AACjB,aAAA;AACD,YAAA,UAAU,EAAE;gBACX,WAAW,EAAE,CAAC,WAAW,CAAC;AAC1B,gBAAA,SAAS,EAAE;oBACV,OAAO,EAAE,OAAO,EAAE,OAAO;AACzB,iBAAA;AACD,aAAA;AACD,SAAA,CAAC,CACF,CAAC,IAAI,CACL,GAAG,CAAC,CAAC,EAAS,KAAK,EAAwB,CAAC,EAC5C,SAAS,CAAC,CAAC,EAAsB,KAChC,IAAI,CAAC,OAAO,CAAmB,CAAA,0BAAA,CAA4B,CAAC,CAAC,IAAI,CAChE,SAAS,CAAC,CAAC,KAAuB,KACjC,cAAc,CAAC,EAAE,EAAE,KAAkC,CAAC,CACtD,EACD,GAAG,CAAC,MAAM,EAAE,CAAC,CACb,CACD,EACD,WAAW,CAAC,CAAC,CAAC,CACoB,CAAC;KACpC;AAED;;;AAGG;AACH,IAAA,MAAM,CAAC,KAAa,EAAA;AACnB,QAAA,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CACnB,SAAS,CAAC,CAAC,EAAsB,KAChC,mBAAmB,CAAC,EAAE,EAAE;AACvB,YAAA,IAAI,EAAE,KAAK;YACX,KAAK,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE;AAC/B,YAAA,UAAU,EAAE,CAAC,SAAS,EAAE,SAAS,CAAC;AAClC,YAAA,SAAS,EAAE,IAAI,CAAC,OAAO,EAAE,SAAS;AAClC,YAAA,KAAK,EAAE,IAAI,CAAC,OAAO,EAAE,KAAK;AAC1B,YAAA,KAAK,EAAE,IAAI,CAAC,OAAO,EAAE,KAAK,IAAI,EAAE;AAChC,SAAA,CAAC,CACF,EACD,GAAG,CAAC,CAAC,MAAiC,KACrC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAyC,KAAI;YAC7D,MAAM,IAAI,GAAgC,UAAU,CAAC,GAAG,CAAC,SAAS,CAEjE,CAAC;YAEF,OAAO;gBACN,KAAK,EAAE,GAAG,CAAC,QAAqC;gBAChD,SAAS,EAAE,IAAI,CAAC,MAAM,CACrB,CACC,GAA2D,EAC3D,GAAyB,KACtB;;;AAGH,oBAAA,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC;AAE/E,oBAAA,OAAO,GAAG,CAAC;iBACX,EACD,EAAS,CAC0D;aACpE,CAAC;SACF,CAAC,CACF,CACD,CAAC;KACF;AAEO,IAAA,OAAO,CAAI,GAAW,EAAA;QAC7B,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,QAAkB,KAAK,QAAQ,CAAC,IAAI,EAAgB,CAAC,CAAC,CAAC;KAC/F;AACD;;ACjID;;AAEG;;;;"}